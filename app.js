// i18n Translations
const translations = {
    th: {
        app_title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
        nav_add: '‡πÄ‡∏û‡∏¥‡πà‡∏°',
        nav_accounts: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
        nav_statistics: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥',
        nav_settings: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
        total_balance: '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        monthly_income: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',
        monthly_expense: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ',
        savings_goals: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°',
        view_all: '‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
        recent_transactions: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î',
        expense_by_category: '‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î',
        quick_menu: '‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô',
        add_transaction: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        accounts: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
        statistics: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥',
        budget: '‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
        goals: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢',
        challenges: '‡∏ä‡∏≤‡πÄ‡∏•‡∏ô‡∏à‡πå',
        lending: '‡∏¢‡∏∑‡∏°/‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°',
        settings: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',
        add_account: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
        transfer_money: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
        from_account: '‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
        to_account: '‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
        amount: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        transfer: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        add_budget: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
        add_goal: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢',
        add_lending: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        type: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó',
        income: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
        expense: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
        category: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',
        date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
        note: '‡πÇ‡∏ô‡πâ‡∏ï',
        save: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        cancel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        no_data: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        no_goals: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢',
        no_budgets: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
        no_lending: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°/‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°',
        used: '‡πÉ‡∏ä‡πâ‡πÑ‡∏õ',
        from: '‡∏à‡∏≤‡∏Å',
        target: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢',
        end_date: '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î',
        days_left: '‡∏ß‡∏±‡∏ô',
        notifications: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        budget_alert: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô',
        goal_alert: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢',
        data: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        export_csv: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV',
        import_csv: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV',
        borrow: '‡∏¢‡∏∑‡∏°',
        lend: '‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°',
        person_name: '‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô',
        due_date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
        paid: '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß',
        status: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
        pending: '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞',
        completed: '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö',
        overdue: '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
        weekly: '‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå',
        monthly: '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
        challenge_game: '‡∏ä‡∏≤‡πÄ‡∏•‡∏ô‡∏à‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°',
        mini_game: '‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°: ‡∏î‡∏ß‡∏á‡πÑ‡∏ü‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°',
        game_description: '‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏™‡∏ß‡πà‡∏≤‡∏á!',
        consecutive_days: '‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á',
        daily_target: '‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô',
        no_active_goal: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà',
        create_goal: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°'
    },
    en: {
        app_title: 'Money Tracker',
        nav_add: 'Add',
        nav_accounts: 'Accounts',
        nav_statistics: 'Statistics',
        nav_settings: 'Settings',
        total_balance: 'Total Balance',
        monthly_income: 'Monthly Income',
        monthly_expense: 'Monthly Expense',
        savings_goals: 'Savings Goals',
        view_all: 'View All',
        recent_transactions: 'Recent Transactions',
        expense_by_category: 'Expense by Category',
        quick_menu: 'Quick Menu',
        add_transaction: 'Add Transaction',
        accounts: 'Accounts',
        statistics: 'Statistics',
        budget: 'Budget',
        goals: 'Goals',
        challenges: 'Challenges',
        lending: 'Lending',
        settings: 'Settings',
        add_account: 'Add Account',
        transfer_money: 'Transfer Money',
        from_account: 'From Account',
        to_account: 'To Account',
        amount: 'Amount',
        transfer: 'Transfer',
        add_budget: 'Add Budget',
        add_goal: 'Add Goal',
        add_lending: 'Add Record',
        type: 'Type',
        income: 'Income',
        expense: 'Expense',
        category: 'Category',
        date: 'Date',
        note: 'Note',
        save: 'Save',
        cancel: 'Cancel',
        no_data: 'No data yet',
        no_goals: 'No goals yet',
        no_budgets: 'No budgets yet',
        no_lending: 'No lending records yet',
        used: 'Used',
        from: 'from',
        target: 'Target',
        end_date: 'End Date',
        days_left: 'days',
        notifications: 'Notifications',
        budget_alert: 'Alert when budget exceeded',
        goal_alert: 'Alert when near goal',
        data: 'Data',
        export_csv: 'Export CSV',
        import_csv: 'Import CSV',
        borrow: 'Borrow',
        lend: 'Lend',
        person_name: 'Person Name',
        due_date: 'Due Date',
        paid: 'Paid',
        status: 'Status',
        pending: 'Pending',
        completed: 'Completed',
        overdue: 'Overdue',
        weekly: 'Weekly',
        monthly: 'Monthly',
        challenge_game: 'Challenges & Games',
        mini_game: 'Mini Game: Savings Light',
        game_description: 'Save money daily according to your goal to light up!',
        consecutive_days: 'Consecutive days',
        daily_target: 'baht/day',
        no_active_goal: 'No active goal',
        create_goal: 'Create a goal to start the game'
    }
};

// Data Management
class MoneyTracker {
    constructor() {
        this.data = this.loadData();
        this.currentLang = this.data.settings.language || 'th';
        this.init();
    }

    loadData() {
        const saved = localStorage.getItem('moneyTrackerData');
        if (saved) {
            return JSON.parse(saved);
        }
        return {
            accounts: [
                { id: 1, name: '‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', balance: 0, color: '#4a90e2' },
                { id: 2, name: '‡∏≠‡∏≠‡∏°', balance: 0, color: '#50c878' },
                { id: 3, name: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©', balance: 0, color: '#7b68ee' }
            ],
            transactions: [],
            categories: {
                income: ['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
                expense: ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á', '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
            },
            budgets: [],
            goals: [],
            challenges: [],
            lending: [],
            settings: {
                theme: 'light',
                hideBalance: false,
                budgetAlert: true,
                goalAlert: true,
                autoSplit: { spending: 60, savings: 30, extra: 10 },
                language: 'th'
            }
        };
    }

    saveData() {
        localStorage.setItem('moneyTrackerData', JSON.stringify(this.data));
    }

    init() {
        this.setupEventListeners();
        this.loadTheme();
        this.loadLanguage();
        this.updateUI();
        this.setupDateInput();
    }

    t(key) {
        return translations[this.currentLang]?.[key] || key;
    }

    loadLanguage() {
        document.documentElement.lang = this.currentLang;
        this.updateTranslations();
    }

    updateTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            el.textContent = this.t(key);
        });
    }

    toggleLanguage() {
        this.currentLang = this.currentLang === 'th' ? 'en' : 'th';
        this.data.settings.language = this.currentLang;
        this.saveData();
        document.documentElement.lang = this.currentLang;
        this.updateTranslations();
        this.updateUI();
    }

    setupDateInput() {
        const dateInput = document.getElementById('date');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    }

    setupEventListeners() {
        // Language toggle
        document.getElementById('languageToggle')?.addEventListener('click', () => {
            this.toggleLanguage();
        });

        // Theme toggle
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            this.toggleTheme();
        });

        // Hide balance toggle
        document.getElementById('hideBalanceToggle')?.addEventListener('click', () => {
            this.toggleHideBalance();
        });

        // Transfer form will be handled in modal

        // Account management
        document.getElementById('addAccountBtn')?.addEventListener('click', () => {
            this.showAddAccountModal();
        });

        // Budget management
        document.getElementById('addBudgetBtn')?.addEventListener('click', () => {
            this.showAddBudgetModal();
        });

        // Goal management
        document.getElementById('addGoalBtn')?.addEventListener('click', () => {
            this.showAddGoalModal();
        });

        // Lending management
        document.getElementById('addLendingBtn')?.addEventListener('click', () => {
            this.showAddLendingModal();
        });

        // Export/Import
        document.getElementById('exportBtn')?.addEventListener('click', () => {
            this.exportCSV();
        });

        document.getElementById('importBtn')?.addEventListener('click', () => {
            document.getElementById('importFile')?.click();
        });

        document.getElementById('importFile')?.addEventListener('change', (e) => {
            this.importCSV(e.target.files[0]);
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.currentTarget.dataset.tab;
                this.switchTab(tab);
            });
        });

        // Modal close
        document.getElementById('closeModal')?.addEventListener('click', () => {
            this.closeModal();
        });

        document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                this.closeModal();
            }
        });
    }

    showView(viewName) {
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        const view = document.getElementById(viewName);
        const navItem = document.querySelector(`[data-view="${viewName}"]`);
        
        if (view) view.classList.add('active');
        if (navItem) navItem.classList.add('active');

        this.updateUI();
        
        // Redraw charts after a short delay to ensure view is visible
        setTimeout(() => {
            this.updateCharts();
        }, 100);
    }

    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        this.data.settings.theme = newTheme;
        this.saveData();
    }

    loadTheme() {
        const theme = this.data.settings.theme || 'light';
        document.documentElement.setAttribute('data-theme', theme);
    }

    toggleHideBalance() {
        this.data.settings.hideBalance = !this.data.settings.hideBalance;
        this.saveData();
        this.updateBalanceDisplay();
    }

    updateBalanceDisplay() {
        const balanceEl = document.getElementById('totalBalance');
        if (balanceEl) {
            if (this.data.settings.hideBalance) {
                balanceEl.classList.add('hidden');
                balanceEl.textContent = '‡∏ø‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            } else {
                balanceEl.classList.remove('hidden');
                const total = this.data.accounts.reduce((sum, acc) => sum + acc.balance, 0);
                balanceEl.textContent = `‡∏ø${total.toFixed(2)}`;
            }
        }
    }

    addTransaction() {
        const form = document.getElementById('transactionForm');
        const formData = new FormData(form);
        
        const transaction = {
            id: Date.now(),
            type: formData.get('type'),
            amount: parseFloat(formData.get('amount')),
            accountId: parseInt(formData.get('account')),
            category: formData.get('category'),
            date: formData.get('date'),
            note: formData.get('note') || '',
            timestamp: new Date().toISOString()
        };

        // Update account balance
        const account = this.data.accounts.find(a => a.id === transaction.accountId);
        if (account) {
            if (transaction.type === 'income') {
                account.balance += transaction.amount;
            } else {
                account.balance -= transaction.amount;
            }
        }

        this.data.transactions.push(transaction);
        this.saveData();
        form.reset();
        this.setupDateInput();
        this.updateUI();
        this.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    transferMoney() {
        const fromId = parseInt(document.getElementById('fromAccount').value);
        const toId = parseInt(document.getElementById('toAccount').value);
        const amount = parseFloat(document.getElementById('transferAmount').value);

        if (fromId === toId) {
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'error');
            return;
        }

        const fromAccount = this.data.accounts.find(a => a.id === fromId);
        const toAccount = this.data.accounts.find(a => a.id === toId);

        if (!fromAccount || !toAccount) return;
        if (fromAccount.balance < amount) {
            this.showNotification('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
            return;
        }

        fromAccount.balance -= amount;
        toAccount.balance += amount;

        // Record transfer as transactions
        const now = new Date().toISOString();
        this.data.transactions.push({
            id: Date.now(),
            type: 'expense',
            amount: amount,
            accountId: fromId,
            category: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
            date: new Date().toISOString().split('T')[0],
            note: `‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${toAccount.name}`,
            timestamp: now
        });

        this.data.transactions.push({
            id: Date.now() + 1,
            type: 'income',
            amount: amount,
            accountId: toId,
            category: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
            date: new Date().toISOString().split('T')[0],
            note: `‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å ${fromAccount.name}`,
            timestamp: now
        });

        this.saveData();
        document.getElementById('transferForm').reset();
        this.updateUI();
        this.showNotification('‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    updateUI() {
        this.updateDashboard();
        this.updateAccounts();
        this.updateTransactions();
        this.updateCategories();
        this.updateBudgets();
        this.updateGoals();
        this.updateChallenges();
        this.updateLending();
        this.updateCharts();
    }

    updateDashboard() {
        // Total balance
        this.updateBalanceDisplay();

        // Accounts summary
        const accountsSummary = document.getElementById('accountsSummary');
        if (accountsSummary) {
            accountsSummary.innerHTML = this.data.accounts.map(acc => `
                <div class="account-summary-item">
                    <h4>${acc.name}</h4>
                    <p class="amount">‡∏ø${this.data.settings.hideBalance ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : acc.balance.toFixed(2)}</p>
                </div>
            `).join('');
        }

        // Monthly stats
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const monthlyTransactions = this.data.transactions.filter(t => {
            const tDate = new Date(t.date);
            return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
        });

        const monthlyIncome = monthlyTransactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);

        const monthlyExpense = monthlyTransactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

        const incomeEl = document.getElementById('monthlyIncome');
        const expenseEl = document.getElementById('monthlyExpense');
        if (incomeEl) incomeEl.textContent = `‡∏ø${monthlyIncome.toFixed(2)}`;
        if (expenseEl) expenseEl.textContent = `‡∏ø${monthlyExpense.toFixed(2)}`;

        // Recent transactions
        this.updateRecentTransactions();

        // Goals
        this.updateGoalsList();
    }

    updateRecentTransactions() {
        const recentEl = document.getElementById('recentTransactions');
        if (!recentEl) return;

        const recent = [...this.data.transactions]
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, 5);

        if (recent.length === 0) {
            recentEl.innerHTML = `<div class="empty-state"><p>${this.t('no_data')}</p></div>`;
            return;
        }

        recentEl.innerHTML = recent.map(t => {
            const account = this.data.accounts.find(a => a.id === t.accountId);
            return `
                <div class="transaction-item ${t.type}">
                    <div class="transaction-info">
                        <h4>${t.category}</h4>
                        <p>${account?.name || ''} ‚Ä¢ ${this.formatDate(t.date)}</p>
                        ${t.note ? `<p class="text-secondary">${t.note}</p>` : ''}
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}‡∏ø${t.amount.toFixed(2)}
                    </div>
                </div>
            `;
        }).join('');
    }

    updateAccounts() {
        const accountsList = document.getElementById('accountsList');
        if (!accountsList) return;

        accountsList.innerHTML = this.data.accounts.map(acc => `
            <div class="account-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>${acc.name}</h3>
                        <p class="balance-amount" style="font-size: 1.5rem;">
                            ‡∏ø${this.data.settings.hideBalance ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : acc.balance.toFixed(2)}
                        </p>
                    </div>
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: ${acc.color};"></div>
                </div>
            </div>
        `).join('');

        // Update select options
        const accountSelects = document.querySelectorAll('#account, #fromAccount, #toAccount');
        accountSelects.forEach(select => {
            select.innerHTML = this.data.accounts.map(acc => 
                `<option value="${acc.id}">${acc.name}</option>`
            ).join('');
        });
    }

    updateCategories() {
        const type = document.querySelector('input[name="type"]:checked')?.value || 'income';
        const categorySelect = document.getElementById('category');
        if (!categorySelect) return;

        const categories = this.data.categories[type] || [];
        categorySelect.innerHTML = categories.map(cat => 
            `<option value="${cat}">${cat}</option>`
        ).join('');

        // Update when type changes
        document.querySelectorAll('input[name="type"]').forEach(radio => {
            radio.addEventListener('change', () => {
                this.updateCategories();
            });
        });
    }

    updateTransactions() {
        // This is handled by updateRecentTransactions
    }

    updateBudgets() {
        const budgetsList = document.getElementById('budgetsList');
        if (!budgetsList) return;

        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        if (this.data.budgets.length === 0) {
            budgetsList.innerHTML = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p></div>';
            return;
        }

        budgetsList.innerHTML = this.data.budgets.map(budget => {
            const monthlyTransactions = this.data.transactions.filter(t => {
                const tDate = new Date(t.date);
                return t.type === 'expense' &&
                       t.category === budget.category &&
                       tDate.getMonth() === currentMonth &&
                       tDate.getFullYear() === currentYear;
            });

            const used = monthlyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const percentage = (used / budget.amount) * 100;
            const status = percentage >= 100 ? 'exceeded' : percentage >= 80 ? 'warning' : '';

            return `
                <div class="budget-card">
                    <h3>${budget.category}</h3>
                    <div class="budget-usage">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: ‡∏ø${used.toFixed(2)}</span>
                            <span class="${status}">‡∏à‡∏≤‡∏Å ‡∏ø${budget.amount.toFixed(2)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%">
                                ${percentage.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateGoals() {
        this.updateGoalsList();
        this.updateGoalsListFull();
    }

    updateGoalsList() {
        const goalsList = document.getElementById('goalsList');
        if (!goalsList) return;

        if (this.data.goals.length === 0) {
            goalsList.innerHTML = `<div class="empty-state"><p>${this.t('no_goals')}</p></div>`;
            return;
        }

        goalsList.innerHTML = this.data.goals.slice(0, 3).map(goal => {
            const account = this.data.accounts.find(a => a.id === goal.accountId);
            const progress = account ? (account.balance / goal.target) * 100 : 0;
            const daysLeft = Math.ceil((new Date(goal.endDate) - new Date()) / (1000 * 60 * 60 * 24));

            return `
                <div class="goal-card">
                    <h3>${goal.name}</h3>
                    <p>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ø${goal.target.toFixed(2)}</p>
                    <p>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${this.formatDate(goal.endDate)} (${daysLeft} ‡∏ß‡∏±‡∏ô)</p>
                    <div class="goal-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%">
                                ${progress.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateGoalsListFull() {
        const goalsListFull = document.getElementById('goalsListFull');
        if (!goalsListFull) return;

        if (this.data.goals.length === 0) {
            goalsListFull.innerHTML = `<div class="empty-state"><p>${this.t('no_goals')}</p></div>`;
            return;
        }

        goalsListFull.innerHTML = this.data.goals.map(goal => {
            const account = this.data.accounts.find(a => a.id === goal.accountId);
            const progress = account ? (account.balance / goal.target) * 100 : 0;
            const daysLeft = Math.ceil((new Date(goal.endDate) - new Date()) / (1000 * 60 * 60 * 24));

            return `
                <div class="goal-card">
                    <h3>${goal.name}</h3>
                    <p>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ø${goal.target.toFixed(2)}</p>
                    <p>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${this.formatDate(goal.endDate)} (${daysLeft} ‡∏ß‡∏±‡∏ô)</p>
                    <div class="goal-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%">
                                ${progress.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateChallenges() {
        const challengesList = document.getElementById('challengesList');
        if (!challengesList) return;

        // Initialize default challenges if empty
        if (this.data.challenges.length === 0) {
            this.data.challenges = [
                {
                    id: 1,
                    name: '‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏≤‡πÅ‡∏ü 5 ‡∏ß‡∏±‡∏ô',
                    type: 'no_spend',
                    target: 5,
                    current: 0,
                    reward: 100
                },
                {
                    id: 2,
                    name: '‡∏≠‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 20 ‡∏ö‡∏≤‡∏ó',
                    type: 'daily_save',
                    target: 7,
                    current: 0,
                    amount: 20,
                    reward: 150
                }
            ];
            this.saveData();
        }

        challengesList.innerHTML = this.data.challenges.map(challenge => {
            const progress = (challenge.current / challenge.target) * 100;
            return `
                <div class="goal-card">
                    <h3>${challenge.name}</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%">
                            ${challenge.current}/${challenge.target}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Update mini-game
        this.updateMiniGame();
    }

    updateMiniGame() {
        const lightBulbs = document.getElementById('lightBulbs');
        const gameStatus = document.getElementById('gameStatus');
        if (!lightBulbs || !gameStatus) return;

        // Get active goal for the game
        const activeGoal = this.data.goals.find(g => {
            const endDate = new Date(g.endDate);
            return endDate > new Date();
        });

        if (!activeGoal) {
            lightBulbs.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>';
            gameStatus.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°';
            return;
        }

        const account = this.data.accounts.find(a => a.id === activeGoal.accountId);
        const dailyTarget = activeGoal.target / 30; // Assume 30 days
        const today = new Date().toISOString().split('T')[0];
        
        // Count consecutive days of saving
        let consecutiveDays = 0;
        const transactions = this.data.transactions
            .filter(t => t.accountId === activeGoal.accountId && t.type === 'income')
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        // Simple logic: count days with savings
        const daysWithSavings = new Set();
        transactions.forEach(t => {
            if (t.amount >= dailyTarget) {
                daysWithSavings.add(t.date);
            }
        });

        consecutiveDays = daysWithSavings.size;

        // Create light bulbs (max 30)
        const bulbs = Math.min(consecutiveDays, 30);
        lightBulbs.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            const bulb = document.createElement('div');
            bulb.className = `light-bulb ${i < bulbs ? 'on' : ''}`;
            bulb.textContent = i < bulbs ? 'üí°' : '‚ö´';
            lightBulbs.appendChild(bulb);
        }

        gameStatus.textContent = `‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ${consecutiveDays} ‡∏ß‡∏±‡∏ô (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${dailyTarget.toFixed(2)} ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô)`;
    }

    updateLending() {
        const lendingList = document.getElementById('lendingList');
        if (!lendingList) return;

        if (this.data.lending.length === 0) {
            lendingList.innerHTML = `<div class="empty-state"><p>${this.t('no_lending')}</p></div>`;
            return;
        }

        lendingList.innerHTML = this.data.lending.map(lend => {
            const dueDate = new Date(lend.dueDate);
            const now = new Date();
            const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
            const status = lend.paid >= lend.amount ? 'completed' : 
                          daysLeft < 0 ? 'overdue' : 'pending';

            return `
                <div class="lending-item">
                    <h3>${lend.personName}</h3>
                    <p>${lend.type === 'borrow' ? '‡∏¢‡∏∑‡∏°' : '‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°'}: ‡∏ø${lend.amount.toFixed(2)}</p>
                    <p>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß: ‡∏ø${lend.paid.toFixed(2)}</p>
                    <p>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${this.formatDate(lend.dueDate)} (${daysLeft} ‡∏ß‡∏±‡∏ô)</p>
                    <span class="lending-status ${status}">
                        ${status === 'completed' ? '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö' : 
                          status === 'overdue' ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞'}
                    </span>
                </div>
            `;
        }).join('');
    }

    updateCharts() {
        this.updateExpenseChart();
        this.updateWeeklyChart();
        this.updateMonthlyChart();
    }

    updateExpenseChart() {
        const canvas = document.getElementById('expenseChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const monthlyExpenses = this.data.transactions.filter(t => {
            const tDate = new Date(t.date);
            return t.type === 'expense' &&
                   tDate.getMonth() === currentMonth &&
                   tDate.getFullYear() === currentYear;
        });

        const categoryTotals = {};
        monthlyExpenses.forEach(t => {
            categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
        });

        const categories = Object.keys(categoryTotals);
        const amounts = Object.values(categoryTotals);

        // Set canvas size
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = 300;

        if (categories.length === 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.textAlign = 'center';
            ctx.font = '16px sans-serif';
            ctx.fillText(this.t('no_data'), canvas.width / 2, canvas.height / 2);
            return;
        }

        const maxAmount = Math.max(...amounts);
        const barWidth = canvas.width / categories.length;
        const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        categories.forEach((cat, i) => {
            const height = (amounts[i] / maxAmount) * (canvas.height - 60);
            const x = i * barWidth;
            const y = canvas.height - height - 30;

            ctx.fillStyle = colors[i % colors.length];
            ctx.fillRect(x + 10, y, barWidth - 20, height);

            ctx.fillStyle = 'var(--text-color)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(cat, x + barWidth / 2, canvas.height - 10);
            ctx.fillText(`‡∏ø${amounts[i].toFixed(0)}`, x + barWidth / 2, y - 5);
        });
    }

    updateWeeklyChart() {
        const canvas = document.getElementById('weeklyChart') || document.getElementById('weeklyChartModal');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());

        const weekData = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(weekStart);
            date.setDate(weekStart.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];

            const dayExpenses = this.data.transactions
                .filter(t => t.type === 'expense' && t.date === dateStr)
                .reduce((sum, t) => sum + t.amount, 0);

            weekData.push(dayExpenses);
        }

        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = 300;

        const maxAmount = Math.max(...weekData, 1);
        const dayWidth = canvas.width / 7;
        const days = this.currentLang === 'th' 
            ? ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™']
            : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        weekData.forEach((amount, i) => {
            const height = (amount / maxAmount) * (canvas.height - 60);
            const x = i * dayWidth;
            const y = canvas.height - height - 30;

            ctx.fillStyle = 'var(--primary-color)';
            ctx.fillRect(x + 10, y, dayWidth - 20, height);

            ctx.fillStyle = 'var(--text-color)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(days[i], x + dayWidth / 2, canvas.height - 10);
            if (amount > 0) {
                ctx.fillText(`‡∏ø${amount.toFixed(0)}`, x + dayWidth / 2, y - 5);
            }
        });
    }

    updateMonthlyChart() {
        const canvas = document.getElementById('monthlyChart') || document.getElementById('monthlyChartModal');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const now = new Date();
        const months = [];
        const incomeData = [];
        const expenseData = [];

        for (let i = 5; i >= 0; i--) {
            const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            months.push(date.toLocaleDateString(this.currentLang === 'th' ? 'th-TH' : 'en-US', { month: 'short' }));

            const monthTransactions = this.data.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === date.getMonth() &&
                       tDate.getFullYear() === date.getFullYear();
            });

            incomeData.push(
                monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0)
            );

            expenseData.push(
                monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0)
            );
        }

        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = 300;

        const maxAmount = Math.max(...incomeData, ...expenseData, 1);
        const monthWidth = canvas.width / 6;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        months.forEach((month, i) => {
            const incomeHeight = (incomeData[i] / maxAmount) * (canvas.height - 60);
            const expenseHeight = (expenseData[i] / maxAmount) * (canvas.height - 60);
            const x = i * monthWidth;

            // Income bar
            ctx.fillStyle = 'var(--success-color)';
            ctx.fillRect(x + 10, canvas.height - incomeHeight - 30, (monthWidth - 30) / 2, incomeHeight);

            // Expense bar
            ctx.fillStyle = 'var(--danger-color)';
            ctx.fillRect(x + 10 + (monthWidth - 30) / 2, canvas.height - expenseHeight - 30, (monthWidth - 30) / 2, expenseHeight);

            ctx.fillStyle = 'var(--text-color)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(month, x + monthWidth / 2, canvas.height - 10);
        });
    }

    // Modal functions
    showModal(title, content) {
        const modal = document.querySelector('.modal');
        if (modal) {
            modal.classList.remove('large');
        }
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    showAddTransactionModal() {
        const content = `
            <form id="transactionFormModal">
                <div class="form-group">
                    <label data-i18n="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="type" value="income" checked>
                            <span data-i18n="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="type" value="expense">
                            <span data-i18n="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="amountModal" data-i18n="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label>
                    <input type="number" id="amountModal" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="accountModal" data-i18n="accounts">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <select id="accountModal" required></select>
                </div>
                <div class="form-group">
                    <label for="categoryModal" data-i18n="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="categoryModal" required></select>
                </div>
                <div class="form-group">
                    <label for="dateModal" data-i18n="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="dateModal" required>
                </div>
                <div class="form-group">
                    <label for="noteModal" data-i18n="note">‡πÇ‡∏ô‡πâ‡∏ï</label>
                    <textarea id="noteModal" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary" data-i18n="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        `;
        this.showModal(this.t('add_transaction'), content);
        this.updateTranslations();
        
        // Populate selects
        const accountSelect = document.getElementById('accountModal');
        accountSelect.innerHTML = this.data.accounts.map(acc => 
            `<option value="${acc.id}">${acc.name}</option>`
        ).join('');
        
        const type = document.querySelector('input[name="type"]:checked')?.value || 'income';
        const categorySelect = document.getElementById('categoryModal');
        categorySelect.innerHTML = this.data.categories[type].map(cat => 
            `<option value="${cat}">${cat}</option>`
        ).join('');
        
        // Update categories when type changes
        document.querySelectorAll('input[name="type"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const newType = document.querySelector('input[name="type"]:checked').value;
                categorySelect.innerHTML = this.data.categories[newType].map(cat => 
                    `<option value="${cat}">${cat}</option>`
                ).join('');
            });
        });
        
        // Set default date
        document.getElementById('dateModal').value = new Date().toISOString().split('T')[0];
        
        // Handle form submit
        document.getElementById('transactionFormModal').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const transaction = {
                id: Date.now(),
                type: formData.get('type'),
                amount: parseFloat(document.getElementById('amountModal').value),
                accountId: parseInt(document.getElementById('accountModal').value),
                category: document.getElementById('categoryModal').value,
                date: document.getElementById('dateModal').value,
                note: document.getElementById('noteModal').value || '',
                timestamp: new Date().toISOString()
            };

            const account = this.data.accounts.find(a => a.id === transaction.accountId);
            if (account) {
                if (transaction.type === 'income') {
                    account.balance += transaction.amount;
                } else {
                    account.balance -= transaction.amount;
                }
            }

            this.data.transactions.push(transaction);
            this.saveData();
            this.updateUI();
            this.closeModal();
            this.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        });
    }

    showAccountsModal() {
        let accountsHtml = this.data.accounts.map(acc => `
            <div class="account-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>${acc.name}</h3>
                        <p class="balance-amount" style="font-size: 1.5rem;">
                            ‡∏ø${this.data.settings.hideBalance ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : acc.balance.toFixed(2)}
                        </p>
                    </div>
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: ${acc.color};"></div>
                </div>
            </div>
        `).join('');
        
        const content = `
            <div>
                <div style="margin-bottom: 1rem;">
                    <button class="btn-secondary" onclick="app.showAddAccountModal()" style="width: 100%; margin-bottom: 1rem;">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                    </button>
                </div>
                <div id="accountsListModal">${accountsHtml}</div>
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                    <h3>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
                    <form id="transferFormModal">
                        <div class="form-group">
                            <label for="fromAccountModal">‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                            <select id="fromAccountModal" required></select>
                        </div>
                        <div class="form-group">
                            <label for="toAccountModal">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                            <select id="toAccountModal" required></select>
                        </div>
                        <div class="form-group">
                            <label for="transferAmountModal">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label>
                            <input type="number" id="transferAmountModal" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn-primary">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                    </form>
                </div>
            </div>
        `;
        this.showModal(this.t('accounts'), content);
        this.updateTranslations();
        
        // Populate transfer selects
        const fromSelect = document.getElementById('fromAccountModal');
        const toSelect = document.getElementById('toAccountModal');
        fromSelect.innerHTML = this.data.accounts.map(acc => 
            `<option value="${acc.id}">${acc.name}</option>`
        ).join('');
        toSelect.innerHTML = this.data.accounts.map(acc => 
            `<option value="${acc.id}">${acc.name}</option>`
        ).join('');
        
        document.getElementById('transferFormModal').addEventListener('submit', (e) => {
            e.preventDefault();
            this.transferMoneyFromModal();
        });
    }

    transferMoneyFromModal() {
        const fromId = parseInt(document.getElementById('fromAccountModal').value);
        const toId = parseInt(document.getElementById('toAccountModal').value);
        const amount = parseFloat(document.getElementById('transferAmountModal').value);

        if (fromId === toId) {
            this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ', 'error');
            return;
        }

        const fromAccount = this.data.accounts.find(a => a.id === fromId);
        const toAccount = this.data.accounts.find(a => a.id === toId);

        if (!fromAccount || !toAccount) return;
        if (fromAccount.balance < amount) {
            this.showNotification('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
            return;
        }

        fromAccount.balance -= amount;
        toAccount.balance += amount;

        const now = new Date().toISOString();
        this.data.transactions.push({
            id: Date.now(),
            type: 'expense',
            amount: amount,
            accountId: fromId,
            category: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
            date: new Date().toISOString().split('T')[0],
            note: `‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${toAccount.name}`,
            timestamp: now
        });

        this.data.transactions.push({
            id: Date.now() + 1,
            type: 'income',
            amount: amount,
            accountId: toId,
            category: '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
            date: new Date().toISOString().split('T')[0],
            note: `‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å ${fromAccount.name}`,
            timestamp: now
        });

        this.saveData();
        this.updateUI();
        this.closeModal();
        this.showNotification('‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    showStatisticsModal() {
        const content = `
            <div>
                <div class="stats-tabs">
                    <button class="tab-btn active" data-tab="weekly" data-i18n="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
                    <button class="tab-btn" data-tab="monthly" data-i18n="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                </div>
                <div class="tab-content active" id="weeklyTabModal">
                    <canvas id="weeklyChartModal"></canvas>
                </div>
                <div class="tab-content" id="monthlyTabModal">
                    <canvas id="monthlyChartModal"></canvas>
                </div>
            </div>
        `;
        this.showModal(this.t('statistics'), content);
        setTimeout(() => {
            document.querySelector('.modal')?.classList.add('large');
        }, 0);
        this.updateTranslations();
        
        // Setup tabs
        document.querySelectorAll('#modalBody .tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.currentTarget.dataset.tab;
                document.querySelectorAll('#modalBody .tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('#modalBody .tab-content').forEach(c => c.classList.remove('active'));
                e.currentTarget.classList.add('active');
                document.getElementById(`${tab}TabModal`).classList.add('active');
                setTimeout(() => this.updateCharts(), 100);
            });
        });
        
        setTimeout(() => this.updateCharts(), 100);
    }

    showBudgetModal() {
        let budgetsHtml = '';
        if (this.data.budgets.length === 0) {
            budgetsHtml = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p></div>';
        } else {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            budgetsHtml = this.data.budgets.map(budget => {
                const monthlyTransactions = this.data.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return t.type === 'expense' &&
                           t.category === budget.category &&
                           tDate.getMonth() === currentMonth &&
                           tDate.getFullYear() === currentYear;
                });
                const used = monthlyTransactions.reduce((sum, t) => sum + t.amount, 0);
                const percentage = (used / budget.amount) * 100;
                const status = percentage >= 100 ? 'exceeded' : percentage >= 80 ? 'warning' : '';
                
                return `
                    <div class="budget-card">
                        <h3>${budget.category}</h3>
                        <div class="budget-usage">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>${this.t('used')}: ‡∏ø${used.toFixed(2)}</span>
                                <span class="${status}">${this.t('from')} ‡∏ø${budget.amount.toFixed(2)}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%">
                                    ${percentage.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        const content = `
            <div>
                <button class="btn-secondary" onclick="app.showAddBudgetModal()" style="width: 100%; margin-bottom: 1rem;" data-i18n="add_budget">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                </button>
                <div>${budgetsHtml}</div>
            </div>
        `;
        this.showModal(this.t('budget'), content);
        this.updateTranslations();
    }

    showGoalsModal() {
        let goalsHtml = '';
        if (this.data.goals.length === 0) {
            goalsHtml = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p></div>';
        } else {
            goalsHtml = this.data.goals.map(goal => {
                const account = this.data.accounts.find(a => a.id === goal.accountId);
                const progress = account ? (account.balance / goal.target) * 100 : 0;
                const daysLeft = Math.ceil((new Date(goal.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="goal-card">
                        <h3>${goal.name}</h3>
                        <p>${this.t('target')}: ‡∏ø${goal.target.toFixed(2)}</p>
                        <p>${this.t('end_date')}: ${this.formatDate(goal.endDate)} (${daysLeft} ${this.t('days_left')})</p>
                        <div class="goal-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%">
                                    ${progress.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        const content = `
            <div>
                <button class="btn-secondary" onclick="app.showAddGoalModal()" style="width: 100%; margin-bottom: 1rem;" data-i18n="add_goal">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
                </button>
                <div>${goalsHtml}</div>
            </div>
        `;
        this.showModal(this.t('savings_goals'), content);
        this.updateTranslations();
    }

    showChallengesModal() {
        let challengesHtml = '';
        if (this.data.challenges.length === 0) {
            this.data.challenges = [
                {
                    id: 1,
                    name: '‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏≤‡πÅ‡∏ü 5 ‡∏ß‡∏±‡∏ô',
                    type: 'no_spend',
                    target: 5,
                    current: 0,
                    reward: 100
                },
                {
                    id: 2,
                    name: '‡∏≠‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 20 ‡∏ö‡∏≤‡∏ó',
                    type: 'daily_save',
                    target: 7,
                    current: 0,
                    amount: 20,
                    reward: 150
                }
            ];
            this.saveData();
        }
        
        challengesHtml = this.data.challenges.map(challenge => {
            const progress = (challenge.current / challenge.target) * 100;
            return `
                <div class="goal-card">
                    <h3>${challenge.name}</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%">
                            ${challenge.current}/${challenge.target}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        const activeGoal = this.data.goals.find(g => {
            const endDate = new Date(g.endDate);
            return endDate > new Date();
        });
        
        let gameHtml = `<p data-i18n="no_active_goal">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>`;
        if (activeGoal) {
            const account = this.data.accounts.find(a => a.id === activeGoal.accountId);
            const dailyTarget = activeGoal.target / 30;
            const transactions = this.data.transactions
                .filter(t => t.accountId === activeGoal.accountId && t.type === 'income')
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            const daysWithSavings = new Set();
            transactions.forEach(t => {
                if (t.amount >= dailyTarget) {
                    daysWithSavings.add(t.date);
                }
            });
            const consecutiveDays = daysWithSavings.size;
            const bulbs = Math.min(consecutiveDays, 30);
            
            gameHtml = `
                <div id="lightBulbsModal" style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin: 2rem 0;"></div>
                <p>${this.t('consecutive_days')} ${consecutiveDays} ${this.t('days_left')} (${this.t('target')}: ${dailyTarget.toFixed(2)} ${this.t('daily_target')})</p>
            `;
        }
        
        const content = `
            <div>
                <h3>‡∏ä‡∏≤‡πÄ‡∏•‡∏ô‡∏à‡πå</h3>
                <div>${challengesHtml}</div>
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                    <h3>‡∏°‡∏¥‡∏ô‡∏¥‡πÄ‡∏Å‡∏°: ‡∏î‡∏ß‡∏á‡πÑ‡∏ü‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</h3>
                    <div class="game-container">
                        ${gameHtml}
                    </div>
                </div>
            </div>
        `;
        this.showModal(this.t('challenge_game'), content);
        this.updateTranslations();
        
        if (activeGoal) {
            const lightBulbs = document.getElementById('lightBulbsModal');
            for (let i = 0; i < 30; i++) {
                const bulb = document.createElement('div');
                bulb.className = `light-bulb ${i < bulbs ? 'on' : ''}`;
                bulb.textContent = i < bulbs ? 'üí°' : '‚ö´';
                lightBulbs.appendChild(bulb);
            }
        }
    }

    showLendingModal() {
        let lendingHtml = '';
        if (this.data.lending.length === 0) {
            lendingHtml = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°/‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</p></div>';
        } else {
            lendingHtml = this.data.lending.map(lend => {
                const dueDate = new Date(lend.dueDate);
                const now = new Date();
                const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                const status = lend.paid >= lend.amount ? 'completed' : 
                              daysLeft < 0 ? 'overdue' : 'pending';
                
                return `
                    <div class="lending-item">
                        <h3>${lend.personName}</h3>
                        <p>${lend.type === 'borrow' ? '‡∏¢‡∏∑‡∏°' : '‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°'}: ‡∏ø${lend.amount.toFixed(2)}</p>
                        <p>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß: ‡∏ø${lend.paid.toFixed(2)}</p>
                        <p>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${this.formatDate(lend.dueDate)} (${daysLeft} ‡∏ß‡∏±‡∏ô)</p>
                        <span class="lending-status ${status}">
                            ${status === 'completed' ? '‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö' : 
                              status === 'overdue' ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞'}
                        </span>
                    </div>
                `;
            }).join('');
        }
        
        const content = `
            <div>
                <button class="btn-secondary" onclick="app.showAddLendingModal()" style="width: 100%; margin-bottom: 1rem;" data-i18n="add_lending">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <div>${lendingHtml}</div>
            </div>
        `;
        this.showModal(this.t('lending'), content);
        this.updateTranslations();
    }

    showSettingsModal() {
        const content = `
            <div>
                <div class="settings-section">
                    <h3>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <label class="switch-label">
                        <input type="checkbox" id="budgetAlertModal" ${this.data.settings.budgetAlert ? 'checked' : ''}>
                        <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô</span>
                    </label>
                    <label class="switch-label">
                        <input type="checkbox" id="goalAlertModal" ${this.data.settings.goalAlert ? 'checked' : ''}>
                        <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span>
                    </label>
                </div>
                <div class="settings-section">
                    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <button class="btn-secondary" onclick="app.exportCSV(); app.closeModal();" style="width: 100%; margin-bottom: 0.5rem;">
                        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('importFileModal').click();" style="width: 100%;">
                        ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                    </button>
                    <input type="file" id="importFileModal" accept=".csv" style="display: none;">
                </div>
            </div>
        `;
        this.showModal(this.t('settings'), content);
        this.updateTranslations();
        
        document.getElementById('budgetAlertModal').addEventListener('change', (e) => {
            this.data.settings.budgetAlert = e.target.checked;
            this.saveData();
        });
        
        document.getElementById('goalAlertModal').addEventListener('change', (e) => {
            this.data.settings.goalAlert = e.target.checked;
            this.saveData();
        });
        
        document.getElementById('importFileModal').addEventListener('change', (e) => {
            this.importCSV(e.target.files[0]);
            this.closeModal();
        });
    }

    showAddAccountModal() {
        const content = `
            <form id="addAccountForm">
                <div class="form-group">
                    <label data-i18n="add_account">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <input type="text" id="accountName" required>
                </div>
                <div class="form-group">
                    <label>‡∏™‡∏µ</label>
                    <input type="color" id="accountColor" value="#4a90e2">
                </div>
                <button type="submit" class="btn-primary" data-i18n="add_account">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
            </form>
        `;
        this.showModal(this.t('add_account'), content);
        this.updateTranslations();
        
        document.getElementById('addAccountForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('accountName').value;
            const color = document.getElementById('accountColor').value;
            
            this.data.accounts.push({
                id: Date.now(),
                name: name,
                balance: 0,
                color: color
            });
            this.saveData();
            this.updateUI();
            this.closeModal();
            this.showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        });
    }

    showAddBudgetModal() {
        const content = `
            <form id="addBudgetForm">
                <div class="form-group">
                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="budgetCategory" required>
                        ${this.data.categories.expense.map(cat => 
                            `<option value="${cat}">${cat}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ø)</label>
                    <input type="number" id="budgetAmount" step="0.01" min="0" required>
                </div>
                <button type="submit" class="btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</button>
            </form>
        `;
        this.showModal(this.t('add_budget'), content);
        this.updateTranslations();
        
        document.getElementById('addBudgetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            
            this.data.budgets.push({
                id: Date.now(),
                category: category,
                amount: amount
            });
            this.saveData();
            this.updateUI();
            this.closeModal();
            this.showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        });
    }

    showAddGoalModal() {
        const content = `
            <form id="addGoalForm">
                <div class="form-group">
                    <label data-i18n="add_goal">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                    <input type="text" id="goalName" required>
                </div>
                <div class="form-group">
                    <label data-i18n="target">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ø)</label>
                    <input type="number" id="goalTarget" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label data-i18n="end_date">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                    <input type="date" id="goalEndDate" required>
                </div>
                <div class="form-group">
                    <label data-i18n="accounts">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                    <select id="goalAccount" required>
                        ${this.data.accounts.map(acc => 
                            `<option value="${acc.id}">${acc.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <button type="submit" class="btn-primary" data-i18n="add_goal">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
            </form>
        `;
        this.showModal(this.t('add_goal'), content);
        this.updateTranslations();
        
        const endDateInput = document.getElementById('goalEndDate');
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        endDateInput.value = nextMonth.toISOString().split('T')[0];
        
        document.getElementById('addGoalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('goalName').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const endDate = document.getElementById('goalEndDate').value;
            const accountId = parseInt(document.getElementById('goalAccount').value);
            
            this.data.goals.push({
                id: Date.now(),
                name: name,
                target: target,
                endDate: endDate,
                accountId: accountId
            });
            this.saveData();
            this.updateUI();
            this.closeModal();
            this.showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        });
    }

    showAddLendingModal() {
        const content = `
            <form id="addLendingForm">
                <div class="form-group">
                    <label data-i18n="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="lendType" value="borrow" checked>
                            <span data-i18n="borrow">‡∏¢‡∏∑‡∏°</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="lendType" value="lend">
                            <span data-i18n="lend">‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="person_name">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô</label>
                    <input type="text" id="lendPerson" required>
                </div>
                <div class="form-group">
                    <label data-i18n="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label>
                    <input type="number" id="lendAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label data-i18n="due_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label>
                    <input type="date" id="lendDueDate" required>
                </div>
                <button type="submit" class="btn-primary" data-i18n="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        `;
        this.showModal(this.t('add_lending'), content);
        this.updateTranslations();
        
        const dueDateInput = document.getElementById('lendDueDate');
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        dueDateInput.value = nextWeek.toISOString().split('T')[0];
        
        document.getElementById('addLendingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.querySelector('input[name="lendType"]:checked').value;
            const person = document.getElementById('lendPerson').value;
            const amount = parseFloat(document.getElementById('lendAmount').value);
            const dueDate = document.getElementById('lendDueDate').value;
            
            this.data.lending.push({
                id: Date.now(),
                type: type,
                personName: person,
                amount: amount,
                paid: 0,
                dueDate: dueDate
            });
            this.saveData();
            this.updateUI();
            this.closeModal();
            this.showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        });
    }

    switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
        document.getElementById(`${tabName}Tab`)?.classList.add('active');
        
        this.updateCharts();
    }

    exportCSV() {
        const headers = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡πÇ‡∏ô‡πâ‡∏ï'];
        const rows = this.data.transactions.map(t => {
            const account = this.data.accounts.find(a => a.id === t.accountId);
            return [
                t.date,
                t.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                t.amount,
                account?.name || '',
                t.category,
                t.note
            ];
        });

        const csv = [headers, ...rows].map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');

        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        this.showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    importCSV(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split('\n').slice(1); // Skip header
            
            lines.forEach(line => {
                if (!line.trim()) return;
                const cells = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(c => c.replace(/^"|"$/g, ''));
                if (cells.length < 3) return;
                
                // Simple import - you might want to enhance this
                const account = this.data.accounts.find(a => a.name === cells[3]) || this.data.accounts[0];
                const type = cells[1] === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? 'income' : 'expense';
                
                this.data.transactions.push({
                    id: Date.now() + Math.random(),
                    type: type,
                    amount: parseFloat(cells[2]) || 0,
                    accountId: account.id,
                    category: cells[4] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
                    date: cells[0] || new Date().toISOString().split('T')[0],
                    note: cells[5] || '',
                    timestamp: new Date().toISOString()
                });
            });
            
            this.saveData();
            this.updateUI();
            this.showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        };
        reader.readAsText(file);
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('th-TH', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }

    showNotification(message, type = 'success') {
        // Simple notification - you can enhance this
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${type === 'error' ? 'var(--danger-color)' : 'var(--success-color)'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            animation: slideIn 0.3s;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
}

// Initialize app
const app = new MoneyTracker();

// Make app globally accessible for onclick handlers
window.app = app;

// Handle window resize for charts
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        app.updateCharts();
    }, 250);
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

